<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <style>
        #tbUser:empty:before {
            content: "暂无数据";
            color: red;
            font-weight: 700;
            font-size: 12px;
        }
    </style>
</head>
<body>
<h2>用户管理</h2>
<div>
    用户名：
    <input type="text" name="txtSearchName" id="txtSearchName">
    性别：
    <select name="selSex" id="selSex">
        <option value="-1">全部</option>
        <option value="1">男</option>
        <option value="0">女</option>
    </select>
    <button id="btnSearch">查询</button>
</div>
<table>
    <thead>
    <tr>
        <th>用户名</th>
        <th>密码</th>
        <th>操作</th>
    </tr>
    </thead>
    <tbody id="tbUser">

    </tbody>
</table>
<div id="divPage">

</div>
<div>
    <form id="addForm">
        <p><input type="text" name="txtUser" id="txtUser"></p>
        <p><input type="password" name="txtPwd" id="txtPwd"></p>
        <p>
            <button id="btnAdd">添加</button>
        </p>
    </form>
</div>
<script src="js/jquery.3.4.0.js"></script>
<script src="js/ajaxFn.js"></script>
<script type="text/javascript">
    var totalCount;         //总条数
    var totalPage;          //总页数
    var currentPage = 1;    //默认第一页
    var pageSize = 3;       //每页条数
    $(function () {
        getUserList();
        pageBar();
        delEvent();     //给删除按钮添加事件
        addEvent();     //添加按钮的事件
        searchEvent();  //给搜索按钮添加事件
        pageEvent();    //给页码加点击事件
    });

    function pageEvent() {
        $("#divPage").on("click", "button", function () {
            currentPage = Number($(this).text());
            getUserList();
        });
    }

    //显示页码
    function pageBar() {
        var searchName = $("#txtSearchName").val();
        var sex = $("#selSex").val();
        //  1.总条数
        ajax("post", "totalCount.do", true, function (data) {
            var json = JSON.parse(data);
            totalCount = json[0].num;
            totalPage = Math.ceil(totalCount / pageSize);
            $("#divPage").html("");
            for (var i = 1; i <= totalPage; i++) {
                $("#divPage").append(`<button>${i}</button>`);
            }
        }, "user=" + searchName + "&sex=" + sex);
    }

    function searchEvent() {
        $("#btnSearch").click(function () {
            currentPage = 1;
            getUserList();
            pageBar();
        });
    }

    function addEvent() {
        $("#btnAdd").click(function () {
            ajax("post", "/postadd.do", true, function (data) {
                alert(data);
                getUserList();
            }, $("#addForm").serialize());
        });
    }

    function delEvent() {
        $("#tbUser").on("click", ".del", function () {
            var id = $(this).attr("data-id");
            ajax("get", "delete.do", true, function (data) {
                alert(data);
                getUserList();
            }, "uid=" + id);
        });
    }

    function getUserList() {
        var searchName = $("#txtSearchName").val();
        var sex = $("#selSex").val();

        ajax("post", "search.do", true, function (data) {
            var json = JSON.parse(data);
            displayUserData(json);
        }, "user=" + searchName + "&sex=" + sex + "&curPage=" + currentPage + "&pageSize=" + pageSize);
    }

    function displayUserData(arr) {
        $("#tbUser").html("");
        arr.forEach(function (item, index) {
            $("#tbUser").append(`<tr><td>${item.username}</td><td>${item.pwd}</td><td><button class="del" data-id="${item.id}">删除</button></td></tr>`)
        });
    }

</script>
</body>
</html>